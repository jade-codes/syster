name: Auto-notify Copilot on CI Failure

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  notify-copilot:
    if: github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.event == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      actions: read
      contents: read
    
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${github.event.workflow_run.head_branch}`,
              state: 'open'
            });
            
            if (pulls.data.length === 0) {
              console.log('No open PR found for this branch');
              return 'none';
            }
            
            return pulls.data[0].number.toString();
          result-encoding: string
      
      - name: Check if already notified
        if: steps.pr.outputs.result != 'none'
        id: check-notified
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.result }}');
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });
            
            // Check if Copilot was already notified in the last 5 comments
            const recentComments = comments.data.slice(-5);
            const alreadyNotified = recentComments.some(comment => 
              comment.body.includes('@copilot') && 
              comment.body.includes('CI pipeline failed')
            );
            
            return alreadyNotified ? 'true' : 'false';
          result-encoding: string
      
      - name: Get workflow run logs URL
        if: steps.pr.outputs.result != 'none' && steps.check-notified.outputs.result == 'false'
        id: logs
        uses: actions/github-script@v7
        with:
          script: |
            const runId = github.event.workflow_run.id;
            const url = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            return url;
          result-encoding: string
      
      - name: Comment on PR
        if: steps.pr.outputs.result != 'none' && steps.check-notified.outputs.result == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.result }}');
            const logsUrl = '${{ steps.logs.outputs.result }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `@copilot The CI pipeline failed. Please analyze the errors and fix the issues.\n\nðŸ“‹ [View failed workflow run](${logsUrl})`
            });
